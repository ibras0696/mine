# Руководство по запуску и эксплуатации сервера Minecraft Forge 1.20.1

Этот документ описывает быстрый старт и типовые операции с Docker-стеком из репозитория. Все команды рассчитаны на запуск из корня проекта.

## 1. Предварительные условия

- Linux-сервер (Ubuntu 22.04 рекомендована) c установленными Docker и Docker Compose plugin.
- Права пользователя на работу с Docker без `sudo` (см. раздел подготовки VPS в `README.md`).
- Свободные ресурсы: минимум 2 vCPU, 4–6 ГБ RAM и 20 ГБ SSD.

## 2. Структура проекта

```
mc-forge/
  docker-compose.yml
  .env.example
  Makefile
  data/
    my_world/
    mods/
    config/
    logs/
```

- `docker-compose.yml` — описание контейнера `itzg/minecraft-server:java17` c Forge 1.20.1.
- `data/` — общая папка, попадает внутрь контейнера как `/data`. Хранит мир, моды, логи и конфиги.
- `Makefile` — набор команд для рутинных операций.

## 3. Первичная настройка

1. Склонируйте репозиторий и перейдите в каталог проекта.
2. Выполните команду `make setup`:
   - создаст необходимые папки в `data/`;
   - скопирует `.env.example` в `.env`, если файл отсутствует.
3. Отредактируйте `.env` и задайте нужные значения (память, имя мира, режим, whitelist и т.п.).

> ⚠️ Имя мира (`LEVEL`) должно совпадать с названием папки в `data/`. По умолчанию используется `my_world`.

## 4. Запуск и остановка сервера

| Действие | Команда |
|----------|---------|
| Запуск (или создание) стека | `make up` |
| Остановка без удаления контейнера | `make stop` |
| Повторный запуск после `stop` | `make start` |
| Полная остановка и удаление контейнера | `make down` |
| Перезапуск только сервиса Minecraft | `make restart` |

При первом запуске будет загружен образ `itzg/minecraft-server:java17` и создан мир (если его ещё нет).

## 5. Мониторинг и диагностика

- **Логи сервера**: `make logs` (следит в режиме `docker compose logs -f`).
- **Статус контейнеров**: `make status`.
- **Проверка параметров**: убедитесь, что значения из `.env` применились (они выводятся в логах при старте).

Логи сохраняются в `data/logs/latest.log`. Их можно просматривать как внутри контейнера, так и напрямую из файловой системы хоста.

## 6. Обновление образа и модификации

1. **Обновить версию контейнера**:
   ```bash
   make pull
   make up
   ```
   Команда `make up` автоматически прокатит изменения в compose.

2. **Добавить или обновить моды**:
   - Скопируйте `.jar` в `data/mods/`.
   - Перезапустите сервер: `make restart`.

3. **Изменить настройки**:
   - Обновите `.env`.
   - Примените изменения: `make up`.

## 7. Работа с миром

- Текущий мир хранится в `data/my_world/` (или другом каталоге, указанном в `LEVEL`).
- Для импорта существующего мира:
  1. Остановите сервер (`make stop`).
  2. Скопируйте папку мира в `data/` и убедитесь, что имя совпадает с `LEVEL`.
  3. Запустите сервер (`make start`).
- Для резервного копирования просто архивируйте папку `data/my_world/`.

## 8. Безопасность и доступ

- **Режим whitelist**: включите переменные `ENABLE_WHITELIST`, `ENFORCE_WHITELIST`, `WHITELIST` в `.env` и перезапустите сервер.
- **Онлайн-режим** (`ONLINE_MODE`) должен быть `TRUE` для лицензионных аккаунтов. При использовании оффлайн-лаунчеров установите `FALSE`, но учитывайте риски.
- Рекомендуется подключение через ZeroTier VPN. Альтернативно — открыть порт `25565/tcp` в `ufw`.
- В качестве альтернативы ZeroTier можно использовать Radmin VPN (см. `docs/vpn/RADMIN.md`).

## 9. Частые проблемы

| Симптом | Возможная причина и решение |
|---------|-----------------------------|
| Контейнер сразу завершается | Недостаточно RAM или неверные mod-файлы. Увеличьте `MEMORY`, проверьте моды. |
| Клиент не может подключиться | Убедитесь, что порт открыт/доступен через VPN, версии модов совпадают. |
| Загружается не тот мир | Проверьте `LEVEL` в `.env` и имя папки в `data/`. Linux чувствителен к регистру. |
| Сильные лаги | Снизьте `VIEW_DISTANCE`, `SIMULATION_DISTANCE`, увеличьте выделенную память и vCPU. |

## 10. Полезные команды Docker (опционально)

Если нужно выполнить команду вручную, используйте следующие примеры:

```bash
# Однократный просмотр логов
docker compose logs mc | tail

# Вход в оболочку контейнера (для отладки)
docker compose exec mc bash
```

> Используйте ручные команды только при необходимости. Большинство задач закрывается целями из `Makefile`.

---

Готово! Для пошагового развертывания и дополнительных подсказок см. основной `README.md`.
