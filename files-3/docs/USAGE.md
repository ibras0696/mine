# Руководство по запуску и эксплуатации сервера Minecraft Forge 1.20.1

Этот документ описывает быстрый старт и типовые операции с Docker-стеком из репозитория. Все команды рассчитаны на запуск из корня проекта.

## 1. Предварительные условия

- Права пользователя на работу с Docker без `sudo` (см. раздел подготовки VPS в `README.md`).
### Проверка зависимостей

```bash
docker --version
docker compose version
make --version
```

Если команда не найдена:
- для Docker повторно установите пакеты `docker-ce` и `docker-compose-plugin` и убедитесь, что сервис запущен `sudo systemctl status docker`;
- после добавления пользователя в группу `docker` обязательно перелогиньтесь или выполните `newgrp docker`;
- на других дистрибутивах уточните пакетные имена или поставьте Docker Desktop.

- Свободные ресурсы: минимум 2 vCPU, 4–6 ГБ RAM и 20 ГБ SSD.

## 2. Структура проекта

```
mc-forge/
  docker-compose.yml
  .env.example
  Makefile
  data/
    my_world/
    mods/
    config/
    logs/
```

- `docker-compose.yml` — описание контейнера `itzg/minecraft-server:java17` c Forge 1.20.1.
- `data/` — общая папка, попадает внутрь контейнера как `/data`. Хранит мир, моды, логи и конфиги.
- `Makefile` — набор команд для рутинных операций.

## 3. Первичная настройка

1. Склонируйте репозиторий и перейдите в каталог проекта.
2. Выполните команду `make setup`:
   - создаст необходимые папки в `data/`;
   - скопирует `.env.example` в `.env`, если файл отсутствует.
3. Отредактируйте `.env` и задайте нужные значения (память, имя мира, режим, whitelist и т.п.).

> Для креативного сервера пропиши `MODE=creative`, `FORCE_GAMEMODE=true`, `ALLOW_CHEATS=true` и, при необходимости, `ONLINE_MODE=FALSE` (для оффлайн-лаунчеров). После сохранения перезапусти стек командой `make down && make up`.

> ⚠️ Имя мира (`LEVEL`) должно совпадать с названием папки в `data/`. По умолчанию используется `my_world`.
> Подробные параметры и примеры см. в `docs/SERVER_SETTINGS.md`.

## 4. Запуск и остановка сервера

| Действие | Команда |
|----------|---------|
| Запуск (или создание) стека | `make up` |
| Остановка без удаления контейнера | `make stop` |
| Повторный запуск после `stop` | `make start` |
| Полная остановка и удаление контейнера | `make down` |
| Перезапуск только сервиса Minecraft | `make restart` |

При первом запуске будет загружен образ `itzg/minecraft-server:java17` и создан мир (если его ещё нет).

## 5. Мониторинг и диагностика

- **Логи сервера**: `make logs` (следит в режиме `docker compose logs -f`).
- **Статус контейнеров**: `make status`.
- **Проверка параметров**: убедитесь, что значения из `.env` применились (они выводятся в логах при старте).

Логи сохраняются в `data/logs/latest.log`. Их можно просматривать как внутри контейнера, так и напрямую из файловой системы хоста.

## 6. Обновление образа и модификации

1. **Обновить версию контейнера**:
   ```bash
   make pull
   make up
   ```
   Команда `make up` автоматически прокатит изменения в compose.

2. **Добавить или обновить моды**:
   - Скопируйте `.jar` в `data/mods/`.
   - Перезапустите сервер: `make restart`.

3. **Изменить настройки**:
   - Обновите `.env`.
   - Примените изменения: `make up`.

## 7. Работа с миром

- Текущий мир хранится в `data/my_world/` (или другом каталоге, указанном в `LEVEL`).
- Важный момент: корневая папка мира должна содержать файлы `level.dat`, `region/`, `playerdata/` и т.п. Не помещай сохранение во вложенную подпапку (`my_world/старый_мир/…`). Если нужно использовать чужой мир — скопируй его содержимое непосредственно в `data/<LEVEL>` или укажи `LEVEL` на фактическую папку.
- Для импорта существующего мира:
  1. Остановите сервер (`make stop`).
   2. Скопируйте содержимое мира в `data/` и убедитесь, что имя папки совпадает с `LEVEL`.
  3. Запустите сервер (`make start`).
- Для резервного копирования просто архивируйте папку `data/my_world/`.

## 8. Безопасность и доступ

- **Режим whitelist**: включите переменные `ENABLE_WHITELIST`, `ENFORCE_WHITELIST`, `WHITELIST` в `.env` и перезапустите сервер.
- **Онлайн-режим** (`ONLINE_MODE`) должен быть `TRUE` для лицензионных аккаунтов. При использовании оффлайн-лаунчеров установите `FALSE` и обязательно включите whitelist (`ENABLE_WHITELIST=true`, `WHITELIST=...`).
- **Администрирование и выдача OP**: см. `docs/ADMIN.md` (как включить `allow-cheats`, выдать/снять права).
- Рекомендуется подключение через ZeroTier VPN. Альтернативно — открыть порт `25565/tcp` в `ufw`.
- В качестве альтернативы ZeroTier можно использовать Radmin VPN (см. `docs/vpn/RADMIN.md`).

## 9. Частые проблемы

| Симптом | Возможная причина и решение |
|---------|-----------------------------|
| Контейнер сразу завершается | Недостаточно RAM или неверные mod-файлы. Увеличьте `MEMORY`, проверьте моды. |
| В логах `Native memory allocation (mmap) failed` | На хосте мало RAM/SWAP. Уменьшите `MEMORY` (например, до `3G`/`2G`) или добавьте swap (`sudo fallocate -l 2G /swapfile; sudo chmod 600 /swapfile; sudo mkswap /swapfile; sudo swapon /swapfile`). |
| Клиент не может подключиться | Убедитесь, что порт открыт/доступен через VPN, версии модов совпадают. |
| Загружается не тот мир | Проверьте `LEVEL` в `.env` и имя папки в `data/`. Linux чувствителен к регистру. |
| Сильные лаги | Снизьте `VIEW_DISTANCE`, `SIMULATION_DISTANCE`, увеличьте выделенную память и vCPU. |

## 10. Полезные команды Docker (опционально)

Если нужно выполнить команду вручную, используйте следующие примеры:

```bash
# Однократный просмотр логов
docker compose logs mc | tail

# Вход в оболочку контейнера (для отладки)
docker compose exec mc bash
```

> Используйте ручные команды только при необходимости. Большинство задач закрывается целями из `Makefile`.

---

Готово! Для пошагового развертывания и дополнительных подсказок см. основной `README.md`.
